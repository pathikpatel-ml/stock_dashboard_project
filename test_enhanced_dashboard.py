#!/usr/bin/env python3
\"\"\"\nComprehensive Test Script for Enhanced Stock Dashboard\n\nThis script tests all new features including:\n- All technical indicators (RSI, MACD, Bollinger Bands, etc.)\n- Sentiment analysis integration\n- Notification system\n- Enhanced UI components\n- Real-time data processing\n\nRun this before starting the dashboard to ensure everything works.\n\"\"\"\n\nimport sys\nimport os\nimport numpy as np\nimport pandas as pd\nfrom datetime import datetime, timedelta\nimport traceback\n\n# Add project root to path\nsys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))\n\ndef test_technical_indicators():\n    \"\"\"Test all technical indicators\"\"\"\n    print(\"\\nğŸ”§ Testing Technical Indicators...\")\n    \n    try:\n        from src.indicators import (\n            RSI, MACD, BollingerBands, StochasticOscillator, \n            ADX, ATR, IchimokuCloud, KeltnerChannel, \n            AdvancedIndicatorCalculator, identify_signals\n        )\n        \n        # Generate sample data\n        np.random.seed(42)\n        prices = 100 + np.cumsum(np.random.randn(100) * 0.5)\n        high_prices = prices + np.random.rand(100) * 2\n        low_prices = prices - np.random.rand(100) * 2\n        \n        # Test individual indicators\n        indicators_to_test = [\n            (\"RSI\", RSI()),\n            (\"MACD\", MACD()),\n            (\"Bollinger Bands\", BollingerBands()),\n            (\"Stochastic Oscillator\", StochasticOscillator()),\n            (\"ADX\", ADX()),\n            (\"ATR\", ATR()),\n            (\"Ichimoku Cloud\", IchimokuCloud()),\n            (\"Keltner Channel\", KeltnerChannel())\n        ]\n        \n        results = {}\n        \n        for name, indicator in indicators_to_test:\n            try:\n                if name in [\"RSI\", \"MACD\", \"Bollinger Bands\", \"Stochastic Oscillator\"]:\n                    if name == \"MACD\":\n                        result = indicator.calculate(prices)\n                        results[name] = f\"âœ… MACD: {len(result[0])} values\"\n                    elif name == \"Bollinger Bands\":\n                        result = indicator.calculate(prices)\n                        results[name] = f\"âœ… BB: {len(result[0])} values\"\n                    elif name == \"Stochastic Oscillator\":\n                        result = indicator.calculate(prices, high_prices, low_prices)\n                        results[name] = f\"âœ… Stoch: {len(result[0])} values\"\n                    else:\n                        result = indicator.calculate(prices)\n                        results[name] = f\"âœ… {name}: {len(result)} values\"\n                else:\n                    if name in [\"ADX\", \"ATR\"]:\n                        result = indicator.calculate(high_prices, low_prices, prices)\n                        results[name] = f\"âœ… {name}: {len(result)} values\"\n                    elif name == \"Ichimoku Cloud\":\n                        result = indicator.calculate(high_prices, low_prices)\n                        results[name] = f\"âœ… Ichimoku: {len(result['tenkan'])} values\"\n                    elif name == \"Keltner Channel\":\n                        result = indicator.calculate(high_prices, low_prices, prices)\n                        results[name] = f\"âœ… Keltner: {len(result['ema'])} values\"\n                        \n            except Exception as e:\n                results[name] = f\"âŒ Error: {str(e)[:50]}...\"\n        \n        # Test unified calculator\n        try:\n            calc = AdvancedIndicatorCalculator(cache_enabled=True)\n            all_indicators = calc.calculate_all(prices, high_prices, low_prices)\n            results[\"Unified Calculator\"] = f\"âœ… All indicators: {len(all_indicators)} calculated\"\n        except Exception as e:\n            results[\"Unified Calculator\"] = f\"âŒ Error: {str(e)[:50]}...\"\n        \n        # Test signal identification\n        try:\n            signals = identify_signals(all_indicators)\n            results[\"Signal Identification\"] = f\"âœ… Signals: {len(signals)} types identified\"\n        except Exception as e:\n            results[\"Signal Identification\"] = f\"âŒ Error: {str(e)[:50]}...\"\n        \n        # Print results\n        for name, result in results.items():\n            print(f\"  {result}\")\n        \n        passed = sum(1 for r in results.values() if r.startswith(\"âœ…\"))\n        total = len(results)\n        print(f\"\\nğŸ“Š Technical Indicators: {passed}/{total} tests passed\")\n        \n        return passed == total\n        \n    except ImportError as e:\n        print(f\"âŒ Import Error: {e}\")\n        return False\n    except Exception as e:\n        print(f\"âŒ Unexpected Error: {e}\")\n        traceback.print_exc()\n        return False\n\ndef test_sentiment_analysis():\n    \"\"\"Test sentiment analysis functionality\"\"\"\n    print(\"\\nğŸ§  Testing Sentiment Analysis...\")\n    \n    try:\n        from modules.news_sentiment_analyzer import SentimentAnalyzer, NewsAPIPatcher\n        \n        # Test sentiment analyzer\n        analyzer = SentimentAnalyzer()\n        \n        test_texts = [\n            \"This stock is performing excellently with strong growth potential\",\n            \"Market conditions are terrible and stocks are falling\",\n            \"The company reported neutral earnings with mixed results\",\n            \"Breaking: Major acquisition announced, stock price soaring\",\n            \"Economic uncertainty continues to impact market performance\"\n        ]\n        \n        results = []\n        \n        for i, text in enumerate(test_texts, 1):\n            try:\n                sentiment = analyzer.analyze(text)\n                if sentiment and 'vader' in sentiment:\n                    compound = sentiment['vader'].get('compound', 0)\n                    results.append(f\"âœ… Text {i}: Sentiment {compound:.2f}\")\n                else:\n                    results.append(f\"âš ï¸ Text {i}: No sentiment data\")\n            except Exception as e:\n                results.append(f\"âŒ Text {i}: Error - {str(e)[:30]}...\")\n        \n        # Test news fetcher (without API key)\n        try:\n            fetcher = NewsAPIPatcher(api_key=\"test_key\")\n            # This will fail without real API key, but we test the class instantiation\n            results.append(\"âœ… News fetcher: Class instantiated\")\n        except Exception as e:\n            results.append(f\"âš ï¸ News fetcher: {str(e)[:40]}...\")\n        \n        # Print results\n        for result in results:\n            print(f\"  {result}\")\n        \n        passed = sum(1 for r in results if r.startswith(\"âœ…\"))\n        total = len(results)\n        print(f\"\\nğŸ§  Sentiment Analysis: {passed}/{total} tests passed\")\n        \n        return passed >= total * 0.8  # 80% pass rate acceptable\n        \n    except ImportError as e:\n        print(f\"âŒ Import Error: {e}\")\n        return False\n    except Exception as e:\n        print(f\"âŒ Unexpected Error: {e}\")\n        return False\n\ndef test_signal_generator():\n    \"\"\"Test signal generation functionality\"\"\"\n    print(\"\\nğŸ“ˆ Testing Signal Generator...\")\n    \n    try:\n        from modules.signal_generator import SignalGenerator, SignalType, TradingSignal\n        \n        # Create sample OHLCV data\n        np.random.seed(42)\n        dates = pd.date_range(start='2024-01-01', periods=100, freq='D')\n        prices = 100 + np.cumsum(np.random.randn(100) * 0.5)\n        \n        sample_data = pd.DataFrame({\n            'Date': dates,\n            'Open': prices + np.random.randn(100) * 0.2,\n            'High': prices + np.random.rand(100) * 2,\n            'Low': prices - np.random.rand(100) * 2,\n            'Close': prices,\n            'Volume': np.random.randint(1000000, 10000000, 100)\n        })\n        \n        results = []\n        \n        # Test signal generator instantiation\n        try:\n            generator = SignalGenerator(min_agreement_ratio=0.5)\n            results.append(\"âœ… Signal generator: Instantiated successfully\")\n        except Exception as e:\n            results.append(f\"âŒ Signal generator: {str(e)[:40]}...\")\n            return False\n        \n        # Test signal generation\n        try:\n            signal = generator.generate(sample_data, 'TEST')\n            if signal:\n                results.append(f\"âœ… Signal generation: {signal.signal_type.name} with {signal.confidence_score:.1f}% confidence\")\n            else:\n                results.append(\"âš ï¸ Signal generation: No signal generated\")\n        except Exception as e:\n            results.append(f\"âŒ Signal generation: {str(e)[:40]}...\")\n        \n        # Test signal types\n        try:\n            signal_types = [SignalType.BUY, SignalType.SELL, SignalType.HOLD, SignalType.NEUTRAL]\n            results.append(f\"âœ… Signal types: {len(signal_types)} types available\")\n        except Exception as e:\n            results.append(f\"âŒ Signal types: {str(e)[:40]}...\")\n        \n        # Print results\n        for result in results:\n            print(f\"  {result}\")\n        \n        passed = sum(1 for r in results if r.startswith(\"âœ…\"))\n        total = len(results)\n        print(f\"\\nğŸ“ˆ Signal Generator: {passed}/{total} tests passed\")\n        \n        return passed >= total * 0.8\n        \n    except ImportError as e:\n        print(f\"âŒ Import Error: {e}\")\n        return False\n    except Exception as e:\n        print(f\"âŒ Unexpected Error: {e}\")\n        return False\n\ndef test_notification_engine():\n    \"\"\"Test notification system\"\"\"\n    print(\"\\nğŸ”” Testing Notification Engine...\")\n    \n    try:\n        from modules.notification_engine import (\n            get_notification_engine, NotificationChannel, AlertType, \n            NotificationPriority, AlertThreshold\n        )\n        \n        results = []\n        \n        # Test notification engine instantiation\n        try:\n            engine = get_notification_engine(async_mode=False)  # Sync mode for testing\n            results.append(\"âœ… Notification engine: Instantiated successfully\")\n        except Exception as e:\n            results.append(f\"âŒ Notification engine: {str(e)[:40]}...\")\n            return False\n        \n        # Test notification creation\n        try:\n            notification_id = engine.notify(\n                title=\"Test Notification\",\n                message=\"This is a test notification for the dashboard\",\n                alert_type=AlertType.TECHNICAL_SIGNAL,\n                symbol=\"TEST\",\n                priority=NotificationPriority.MEDIUM\n            )\n            if notification_id:\n                results.append(f\"âœ… Notification creation: ID {notification_id[:8]}...\")\n            else:\n                results.append(\"âš ï¸ Notification creation: No ID returned\")\n        except Exception as e:\n            results.append(f\"âŒ Notification creation: {str(e)[:40]}...\")\n        \n        # Test alert threshold\n        try:\n            threshold = AlertThreshold(\n                alert_type=AlertType.PRICE_ALERT,\n                symbol=\"TEST\",\n                condition=\"price > 100\",\n                value=100.0\n            )\n            alert_id = engine.add_alert_threshold(threshold)\n            results.append(f\"âœ… Alert threshold: Added with ID {alert_id[:8]}...\")\n        except Exception as e:\n            results.append(f\"âŒ Alert threshold: {str(e)[:40]}...\")\n        \n        # Test notification history\n        try:\n            history = engine.get_notification_history(limit=10)\n            results.append(f\"âœ… Notification history: {len(history)} notifications\")\n        except Exception as e:\n            results.append(f\"âŒ Notification history: {str(e)[:40]}...\")\n        \n        # Test in-app notifications\n        try:\n            in_app = engine.get_in_app_notifications(limit=5)\n            results.append(f\"âœ… In-app notifications: {len(in_app)} notifications\")\n        except Exception as e:\n            results.append(f\"âŒ In-app notifications: {str(e)[:40]}...\")\n        \n        # Print results\n        for result in results:\n            print(f\"  {result}\")\n        \n        passed = sum(1 for r in results if r.startswith(\"âœ…\"))\n        total = len(results)\n        print(f\"\\nğŸ”” Notification Engine: {passed}/{total} tests passed\")\n        \n        return passed >= total * 0.8\n        \n    except ImportError as e:\n        print(f\"âŒ Import Error: {e}\")\n        return False\n    except Exception as e:\n        print(f\"âŒ Unexpected Error: {e}\")\n        return False\n\ndef test_dashboard_components():\n    \"\"\"Test dashboard layout and callback components\"\"\"\n    print(\"\\nğŸ–¥ï¸ Testing Dashboard Components...\")\n    \n    try:\n        results = []\n        \n        # Test V20 layout\n        try:\n            from modules.v20_layout import create_v20_layout\n            layout = create_v20_layout()\n            results.append(\"âœ… V20 layout: Created successfully\")\n        except Exception as e:\n            results.append(f\"âŒ V20 layout: {str(e)[:40]}...\")\n        \n        # Test MA layout\n        try:\n            from modules.ma_layout import create_ma_layout\n            layout = create_ma_layout()\n            results.append(\"âœ… MA layout: Created successfully\")\n        except Exception as e:\n            results.append(f\"âŒ MA layout: {str(e)[:40]}...\")\n        \n        # Test callback modules (import only)\n        try:\n            from modules import v20_callbacks, ma_callbacks\n            results.append(\"âœ… Callback modules: Imported successfully\")\n        except Exception as e:\n            results.append(f\"âŒ Callback modules: {str(e)[:40]}...\")\n        \n        # Test data manager\n        try:\n            import data_manager\n            results.append(\"âœ… Data manager: Imported successfully\")\n        except Exception as e:\n            results.append(f\"âŒ Data manager: {str(e)[:40]}...\")\n        \n        # Test main dashboard file\n        try:\n            # Check if main dashboard file exists and has required components\n            dashboard_files = ['run_dashboard_interactive_host.py', 'app.py']\n            found_dashboard = False\n            for file in dashboard_files:\n                if os.path.exists(file):\n                    found_dashboard = True\n                    break\n            \n            if found_dashboard:\n                results.append(\"âœ… Dashboard file: Found main dashboard file\")\n            else:\n                results.append(\"âš ï¸ Dashboard file: No main dashboard file found\")\n        except Exception as e:\n            results.append(f\"âŒ Dashboard file: {str(e)[:40]}...\")\n        \n        # Print results\n        for result in results:\n            print(f\"  {result}\")\n        \n        passed = sum(1 for r in results if r.startswith(\"âœ…\"))\n        total = len(results)\n        print(f\"\\nğŸ–¥ï¸ Dashboard Components: {passed}/{total} tests passed\")\n        \n        return passed >= total * 0.8\n        \n    except Exception as e:\n        print(f\"âŒ Unexpected Error: {e}\")\n        return False\n\ndef test_data_files():\n    \"\"\"Test required data files\"\"\"\n    print(\"\\nğŸ“ Testing Data Files...\")\n    \n    try:\n        results = []\n        \n        # Check for CSV files\n        csv_patterns = [\n            'stock_candle_signals_from_listing_*.csv',\n            'ma_signals_data_*.csv',\n            'Master_company_market_trend_analysis.csv'\n        ]\n        \n        import glob\n        \n        for pattern in csv_patterns:\n            files = glob.glob(pattern)\n            if files:\n                results.append(f\"âœ… Data files: Found {len(files)} files matching {pattern}\")\n            else:\n                results.append(f\"âš ï¸ Data files: No files found matching {pattern}\")\n        \n        # Check assets folder\n        if os.path.exists('assets'):\n            css_files = glob.glob('assets/*.css')\n            results.append(f\"âœ… Assets: Found {len(css_files)} CSS files\")\n        else:\n            results.append(\"âš ï¸ Assets: No assets folder found\")\n        \n        # Print results\n        for result in results:\n            print(f\"  {result}\")\n        \n        passed = sum(1 for r in results if r.startswith(\"âœ…\"))\n        total = len(results)\n        print(f\"\\nğŸ“ Data Files: {passed}/{total} tests passed\")\n        \n        return passed >= total * 0.6  # Lower threshold for data files\n        \n    except Exception as e:\n        print(f\"âŒ Unexpected Error: {e}\")\n        return False\n\ndef main():\n    \"\"\"Run all tests\"\"\"\n    print(\"ğŸš€ Starting Comprehensive Dashboard Test Suite\")\n    print(\"=\" * 60)\n    \n    test_results = {\n        \"Technical Indicators\": test_technical_indicators(),\n        \"Sentiment Analysis\": test_sentiment_analysis(),\n        \"Signal Generator\": test_signal_generator(),\n        \"Notification Engine\": test_notification_engine(),\n        \"Dashboard Components\": test_dashboard_components(),\n        \"Data Files\": test_data_files()\n    }\n    \n    print(\"\\n\" + \"=\" * 60)\n    print(\"ğŸ“‹ TEST SUMMARY\")\n    print(\"=\" * 60)\n    \n    passed_tests = 0\n    total_tests = len(test_results)\n    \n    for test_name, result in test_results.items():\n        status = \"âœ… PASSED\" if result else \"âŒ FAILED\"\n        print(f\"{test_name:.<30} {status}\")\n        if result:\n            passed_tests += 1\n    \n    print(\"\\n\" + \"=\" * 60)\n    \n    success_rate = (passed_tests / total_tests) * 100\n    \n    if success_rate >= 80:\n        print(f\"ğŸ‰ OVERALL RESULT: SUCCESS ({passed_tests}/{total_tests} - {success_rate:.1f}%)\")\n        print(\"\\nâœ… Your dashboard is ready to run!\")\n        print(\"\\nğŸš€ Start the dashboard with:\")\n        print(\"   python run_dashboard_interactive_host.py\")\n        print(\"   or\")\n        print(\"   python app.py\")\n    elif success_rate >= 60:\n        print(f\"âš ï¸ OVERALL RESULT: PARTIAL SUCCESS ({passed_tests}/{total_tests} - {success_rate:.1f}%)\")\n        print(\"\\nğŸ”§ Some features may not work perfectly, but dashboard should run.\")\n        print(\"\\nğŸ’¡ Consider fixing failed tests for optimal experience.\")\n    else:\n        print(f\"âŒ OVERALL RESULT: FAILURE ({passed_tests}/{total_tests} - {success_rate:.1f}%)\")\n        print(\"\\nğŸš¨ Critical issues detected. Please fix failed tests before running dashboard.\")\n    \n    print(\"\\n\" + \"=\" * 60)\n    print(f\"Test completed at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\")\n    \n    return success_rate >= 60\n\nif __name__ == \"__main__\":\n    success = main()\n    sys.exit(0 if success else 1)\n